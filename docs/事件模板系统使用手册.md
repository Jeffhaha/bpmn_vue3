# 事件模板系统使用手册 (Phase 5.2.1)

## 概述

Phase 5.2.1 已将事件模板从4个扩展到25个完整的BPMN 2.0事件模板，支持DynamicForm自定义属性。本手册将指导您如何测试和使用这些新功能。

## 快速开始

### 1. 启动开发环境

```bash
# 确保开发服务器正在运行
npm run dev

# 访问应用
http://localhost:5173
```

### 2. 打开事件模板面板

1. 在SimpleBpmnModeler页面，点击工具栏上的 **"显示模板"** 按钮
2. 模板面板将在左侧展开，显示 **"节点模板"** 
3. 您应该看到 **"事件"** 分类，其中包含25个事件模板

## 25个事件模板详细说明

### 开始事件 (9个)

| 模板名称 | 图标 | 用途 | DynamicForm配置 |
|---------|------|------|----------------|
| **空开始事件** | ▶️ | 手动启动流程 | 无需配置 |
| **消息开始事件** | 📧 | 接收消息触发 | 消息引用、关联键、消息格式 |
| **定时开始事件** | 🕐 | 按时间启动 | 定时类型、指定时间、周期表达式、时区 |
| **信号开始事件** | 📡 | 接收信号触发 | 信号引用、信号范围 |
| **条件开始事件** | ❓ | 满足条件触发 | 条件表达式、监听变量 |
| **错误开始事件** | ⚠️ | 捕获错误启动 | 错误引用、错误代码 |
| **升级开始事件** | ⬆️ | 处理流程升级 | 升级引用、升级代码 |
| **补偿开始事件** | ↩️ | 启动补偿流程 | 活动引用、等待完成选项 |
| **多重开始事件** | ✳️ | 多种触发条件 | 并行多重选项、事件定义列表 |

### 中间事件 (12个)

| 模板名称 | 类型 | 用途 | DynamicForm配置 |
|---------|------|------|----------------|
| **空中间捕获事件** | 捕获 | 流程暂停点 | 无需配置 |
| **空中间抛出事件** | 抛出 | 流程标记点 | 无需配置 |
| **消息中间捕获事件** | 捕获 | 等待接收消息 | 消息引用、超时时间 |
| **消息中间抛出事件** | 抛出 | 发送消息 | 消息引用、目标地址、异步发送 |
| **定时中间事件** | 捕获 | 延迟处理 | 定时类型、指定时间、延迟时间 |
| **信号中间捕获事件** | 捕获 | 等待接收信号 | 信号引用、信号范围 |
| **信号中间抛出事件** | 抛出 | 发送信号 | 信号引用、信号范围 |
| **条件中间事件** | 捕获 | 条件等待 | 条件表达式、进入时评估 |
| **链接中间捕获事件** | 捕获 | 接收链接 | 链接名称、源链接 |
| **链接中间抛出事件** | 抛出 | 发送链接 | 链接名称、目标链接 |
| **错误中间事件** | 捕获 | 捕获错误 | 错误引用、错误代码 |
| **补偿中间事件** | 抛出 | 触发补偿 | 活动引用、等待完成 |

### 结束事件 (8个)

| 模板名称 | 图标 | 用途 | DynamicForm配置 |
|---------|------|------|----------------|
| **空结束事件** | ⏹️ | 正常结束流程 | 无需配置 |
| **消息结束事件** | 📤 | 发送消息后结束 | 消息引用、目标地址、结束消息内容 |
| **错误结束事件** | ❌ | 错误状态结束 | 错误引用、错误代码、错误消息 |
| **取消结束事件** | 🚫 | 取消事务结束 | 无需配置 |
| **补偿结束事件** | 🔄 | 触发补偿后结束 | 活动引用、补偿范围 |
| **信号结束事件** | 📻 | 发送信号后结束 | 信号引用、信号范围 |
| **多重结束事件** | ⚪ | 执行多个结束操作 | 并行多重、结束事件定义 |
| **终止结束事件** | 🔌 | 立即终止整个流程 | 无需配置 |

## 测试步骤

### 第一步：验证模板加载

1. **打开浏览器开发者工具** (F12)
2. **查看控制台日志**，应该看到：
   ```
   开始加载事件模板包... 25 个模板
   事件模板包加载完成 - 已创建 25 个事件模板
   完整的默认模板库创建完成 - 已加载任务模板(7个) + 事件模板(25个) + 网关模板(4个) = 共36个BPMN模板
   ```

3. **检查模板面板**：
   - 点击 **"显示模板"** 按钮
   - 展开 **"事件"** 分类
   - 确认显示 **(25)** 个模板

### 第二步：拖拽测试

1. **基础拖拽测试**：
   - 从事件分类中拖拽 **"空开始事件"** 到画布
   - 验证成功创建圆形的绿色开始事件
   - 控制台应显示：`BPMN元素创建成功 (支持DynamicForm)`

2. **复杂事件测试**：
   - 拖拽 **"消息开始事件"** 到画布
   - 拖拽 **"定时中间事件"** 到画布
   - 拖拽 **"错误结束事件"** 到画布

### 第三步：DynamicForm测试

1. **选择事件节点**：
   - 点击画布上的消息开始事件
   - 右侧属性面板应该显示该事件的属性

2. **验证DynamicForm配置**：
   - 查看是否有扩展属性支持
   - 检查业务对象中的 `extensionElements`

### 第四步：模板分类测试

1. **搜索功能**：
   - 在模板面板搜索框输入 **"消息"**
   - 应该显示所有包含"消息"的事件模板
   - 尝试搜索 **"开始"**、**"结束"**、**"中间"**

2. **分类过滤**：
   - 使用分类下拉框选择 **"事件"**
   - 确认只显示事件类模板

3. **排序测试**：
   - 切换排序方式：按名称、按使用量、按更新时间
   - 观察模板列表顺序变化

## 使用指南

### 1. 创建基本流程

```
开始 → 消息开始事件
中间 → 定时中间事件 (延迟处理)
结束 → 空结束事件
```

### 2. 创建错误处理流程

```
正常流程 → 用户任务
异常路径 → 错误中间事件 → 错误结束事件
```

### 3. 创建定时流程

```
定时开始事件 (每日9点) → 服务任务 → 空结束事件
```

### 4. 创建消息驱动流程

```
消息开始事件 → 处理任务 → 消息结束事件 (发送回复)
```

## DynamicForm自定义属性指南

### 消息事件配置示例

```json
{
  "messageRef": "OrderMessage",
  "correlationKey": "orderId", 
  "messageFormat": "JSON"
}
```

### 定时事件配置示例

```json
{
  "timerType": "timeCycle",
  "timeCycle": "0 0 9 * * MON-FRI",
  "timezone": "Asia/Shanghai"
}
```

### 条件事件配置示例

```json
{
  "condition": "${amount > 1000}",
  "variables": "amount,status,priority"
}
```

## 故障排除

### 问题1：模板没有显示25个

**可能原因**：
- 事件模板包加载失败
- 浏览器缓存问题

**解决方案**：
1. 清除浏览器缓存并刷新
2. 检查控制台是否有错误日志
3. 确认事件模板包文件存在

### 问题2：拖拽无响应

**可能原因**：
- 拖拽数据格式问题
- 画布未正确初始化

**解决方案**：
1. 检查控制台是否有 `接收到拖拽数据` 日志
2. 确认BPMN建模器已正确初始化
3. 重新启动开发服务器

### 问题3：DynamicForm配置不生效

**可能原因**：
- 属性面板未正确集成DynamicForm
- 扩展元素未正确创建

**解决方案**：
1. 检查元素的 `businessObject.extensionElements` 是否存在
2. 验证模板的 `dynamicFormConfig` 配置
3. 查看属性面板是否支持DynamicForm

## 开发者调试信息

### 控制台关键日志

```javascript
// 模板加载成功
"开始加载事件模板包... 25 个模板"
"事件模板包加载完成 - 已创建 25 个事件模板"

// 拖拽成功  
"模板拖拽开始: 消息开始事件"
"接收到拖拽数据: {type: 'template', source: 'templatePanel', ...}"
"BPMN元素创建成功 (支持DynamicForm): {...}"

// 属性选择
"选中元素: {id: 'StartEvent_xxx', type: 'bpmn:StartEvent', ...}"
```

### 验证数据结构

检查模板数据结构：
```javascript
// 在浏览器控制台执行
import { templateManager } from '@/utils/template-manager'
console.log('所有模板:', templateManager.getAllTemplates())
console.log('事件模板:', templateManager.getTemplatesByCategory('events'))
```

## 下一步

完成5.2.1测试后，您可以：

1. **继续使用更多事件类型**构建复杂流程
2. **测试DynamicForm**自定义属性功能
3. **为Phase 5.2.2做准备**：任务模板扩展 (7→15个)

---

## 技术架构说明

本次更新采用了**模块化模板包架构**：

- **模板包**: `/src/utils/template-packages/event-templates.ts`
- **加载机制**: 动态导入 + 错误回退
- **DynamicForm支持**: 每个模板包含完整的表单配置
- **向后兼容**: 保持原有模板系统不变

这种架构为后续的任务模板、网关模板扩展奠定了基础，支持按需加载和模块化管理。