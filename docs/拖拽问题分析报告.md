# æ‹–æ‹½é—®é¢˜åˆ†ææŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

å½“å‰ç³»ç»Ÿä¸­å…ƒç´ åº“(BpmnPalette)çš„æ‹–æ‹½åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œï¼Œç”¨æˆ·æ— æ³•é€šè¿‡æ‹–æ‹½æ–¹å¼ä»èŠ‚ç‚¹åº“æ·»åŠ BPMNå…ƒç´ åˆ°ç”»å¸ƒã€‚

## æ ¹å› åˆ†æ

### 1. æ•°æ®æ ¼å¼ä¸åŒ¹é… ğŸ”´

#### TemplatePanelï¼ˆå·¥ä½œæ­£å¸¸ï¼‰
```typescript
// æ‹–æ‹½æ•°æ®æ ¼å¼
{
  type: 'template',
  template: NodeTemplate  // å®Œæ•´çš„æ¨¡æ¿å¯¹è±¡
}
```

#### BpmnPaletteï¼ˆæ‹–æ‹½å¤±æ•ˆï¼‰
```typescript
// æ‹–æ‹½æ•°æ®æ ¼å¼
{
  type: element.type,           // ä¾‹å¦‚ 'bpmn:UserTask'
  elementType: 'bpmn-element'   // å›ºå®šå­—ç¬¦ä¸²
}
```

### 2. Dropå¤„ç†å™¨ä¸å…¼å®¹ ğŸ”´

#### SimpleBpmnModeler.handleDrop() å½“å‰é€»è¾‘
```typescript
function handleDrop(event: DragEvent) {
  const dragData = JSON.parse(data)
  
  // åªå¤„ç†templateç±»å‹ï¼
  if (dragData.type === 'template' && dragData.template) {
    // æ¨¡æ¿æ‹–æ‹½å¤„ç†é€»è¾‘
    templateDropHandler.onTemplateDrop(dragData.template, position)
  }
  
  // ç¼ºå°‘å¯¹ 'bpmn-element' ç±»å‹çš„å¤„ç†ï¼
}
```

### 3. ç¼ºå¤±çš„å¤„ç†åˆ†æ”¯

BpmnPaletteçš„æ‹–æ‹½æ•°æ®æ ¼å¼ `{ type: 'bpmn:UserTask', elementType: 'bpmn-element' }` ä¸åŒ¹é…ä»»ä½•ç°æœ‰å¤„ç†é€»è¾‘ï¼Œå¯¼è‡´æ‹–æ‹½æ— æ•ˆã€‚

## é—®é¢˜å½±å“

### ç”¨æˆ·ä½“éªŒå½±å“
- ç”¨æˆ·æ— æ³•ä½¿ç”¨æ ‡å‡†BPMNå…ƒç´ åº“
- åªèƒ½ä¾èµ–æ¨¡æ¿é¢æ¿è¿›è¡ŒèŠ‚ç‚¹åˆ›å»º
- å­¦ä¹ BPMNæ ‡å‡†æ—¶ç¼ºå°‘æ ‡å‡†å…ƒç´ å‚è€ƒ

### åŠŸèƒ½å®Œæ•´æ€§å½±å“  
- èŠ‚ç‚¹åˆ›å»ºæ–¹å¼ä¸å®Œæ•´
- å·¥å…·æ å¼€å…³åŠŸèƒ½éƒ¨åˆ†å¤±æ•ˆ
- ç³»ç»Ÿæ¶æ„è®¾è®¡ç›®æ ‡æœªè¾¾æˆ

## æŠ€æœ¯å€ºåŠ¡

### æ¶æ„å±‚é¢
- ç¼ºå°‘ç»Ÿä¸€çš„æ‹–æ‹½æ•°æ®æ¥å£
- æ²¡æœ‰ç»Ÿä¸€çš„æ‹–æ‹½æºç®¡ç†
- Dropå¤„ç†é€»è¾‘è€¦åˆåº¦é«˜

### ä»£ç å±‚é¢
- ç¡¬ç¼–ç çš„ç±»å‹åˆ¤æ–­
- ç¼ºå°‘é”™è¯¯å¤„ç†å’Œå®¹é”™æœºåˆ¶
- æ²¡æœ‰æ‹–æ‹½æ•°æ®æ ¼å¼éªŒè¯

## è§£å†³æ–¹æ¡ˆè®¾è®¡

### 1. ç»Ÿä¸€æ‹–æ‹½æ•°æ®æ ¼å¼
```typescript
interface UnifiedDragData {
  type: 'template' | 'bpmn-element' | 'custom'
  source: 'templatePanel' | 'bpmnPalette' | 'nodeLibrary'
  
  // é€šç”¨èŠ‚ç‚¹ä¿¡æ¯
  nodeInfo: {
    elementType: string        // BPMNå…ƒç´ ç±»å‹
    name: string              // æ˜¾ç¤ºåç§°  
    category: string          // èŠ‚ç‚¹åˆ†ç±»
    icon: string             // å›¾æ ‡
  }
  
  // æ¡ä»¶æ€§æ•°æ®
  template?: NodeTemplate      // å½“typeä¸º'template'æ—¶
  elementConfig?: {           // å½“typeä¸º'bpmn-element'æ—¶
    properties: Record<string, any>
    defaultValues: Record<string, any>
  }
}
```

### 2. å¢å¼ºDropå¤„ç†å™¨
```typescript
class UnifiedDropHandler {
  handleDrop(event: DragEvent, position: { x: number; y: number }): BpmnElement {
    const dragData: UnifiedDragData = JSON.parse(
      event.dataTransfer.getData('application/json')
    )
    
    switch (dragData.type) {
      case 'template':
        return this.createFromTemplate(dragData.template!, position)
      
      case 'bpmn-element':
        return this.createFromElementType(
          dragData.nodeInfo, 
          dragData.elementConfig!, 
          position
        )
      
      case 'custom':
        return this.createCustomElement(dragData.nodeInfo, position)
      
      default:
        throw new Error(`Unsupported drag type: ${dragData.type}`)
    }
  }
}
```

### 3. ä¿®æ”¹æ–‡ä»¶æ¸…å•

#### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. **BpmnPalette.vue** - ä¿®æ”¹handleDragStartæ–¹æ³•
2. **SimpleBpmnModeler.vue** - å¢å¼ºhandleDropæ–¹æ³•  
3. **TemplatePanel.vue** - éªŒè¯æ ¼å¼å…¼å®¹æ€§ï¼ˆå¯é€‰ï¼‰

#### æ–°å¢çš„æ–‡ä»¶
4. **UnifiedDragHandler.ts** - ç»Ÿä¸€æ‹–æ‹½å¤„ç†å™¨ï¼ˆå¯é€‰ï¼‰

## ä¿®å¤æ—¶é—´ä¼°ç®—

- **åˆ†æå’Œè®¾è®¡**: å·²å®Œæˆ âœ…
- **ä»£ç ä¿®æ”¹**: 2å¤©
- **æµ‹è¯•éªŒè¯**: 1å¤©  
- **æ–‡æ¡£æ›´æ–°**: 0.5å¤©

**æ€»è®¡**: 3.5å¤©

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶ âœ…
- [ ] TemplatePanelæ‹–æ‹½åŠŸèƒ½ä¿æŒæ­£å¸¸
- [ ] BpmnPaletteæ‹–æ‹½åŠŸèƒ½æ¢å¤æ­£å¸¸
- [ ] åŸç”Ÿè°ƒè‰²æ¿æ‹–æ‹½åŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚æœå¯ç”¨ï¼‰
- [ ] è·¨é¢æ¿æ‹–æ‹½å…¼å®¹æ€§è‰¯å¥½

### æŠ€æœ¯éªŒæ”¶ âœ…
- [ ] ç»Ÿä¸€çš„æ‹–æ‹½æ•°æ®æ ¼å¼
- [ ] å¯æ‰©å±•çš„Dropå¤„ç†æ¶æ„
- [ ] å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–å…³é”®è·¯å¾„

### ç”¨æˆ·ä½“éªŒéªŒæ”¶ âœ…
- [ ] æ‹–æ‹½å“åº”å»¶è¿Ÿ < 100ms
- [ ] è§†è§‰åé¦ˆæ¸…æ™°ä¸€è‡´
- [ ] é”™è¯¯æç¤ºç”¨æˆ·å‹å¥½
- [ ] æ”¯æŒæ’¤é”€æ“ä½œ

## é•¿æœŸä¼˜åŒ–å»ºè®®

### æ¶æ„æ”¹è¿›
1. **æ‹–æ‹½ç®¡ç†å™¨** - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æ‹–æ‹½æºå’Œç›®æ ‡
2. **æ’ä»¶åŒ–æ‹–æ‹½** - æ”¯æŒç¬¬ä¸‰æ–¹æ‹–æ‹½å¤„ç†å™¨æ³¨å†Œ
3. **æ‹–æ‹½çŠ¶æ€ç®¡ç†** - é›†ä¸­ç®¡ç†æ‹–æ‹½çŠ¶æ€å’Œä¸Šä¸‹æ–‡

### ç”¨æˆ·ä½“éªŒæ”¹è¿›
1. **æ‹–æ‹½é¢„è§ˆ** - æ˜¾ç¤ºå°†è¦åˆ›å»ºçš„å…ƒç´ é¢„è§ˆ
2. **æ™ºèƒ½å¯¹é½** - è‡ªåŠ¨å¯¹é½åˆ°ç½‘æ ¼æˆ–å…¶ä»–å…ƒç´ 
3. **æ‰¹é‡æ‹–æ‹½** - æ”¯æŒå¤šé€‰å…ƒç´ æ‹–æ‹½

### æ€§èƒ½ä¼˜åŒ–
1. **å»¶è¿ŸåŠ è½½** - å¤§é‡å…ƒç´ çš„è™šæ‹ŸåŒ–æ¸²æŸ“
2. **ç¼“å­˜æœºåˆ¶** - æ‹–æ‹½æ•°æ®å’Œä½ç½®è®¡ç®—ç¼“å­˜
3. **äº‹ä»¶ä¼˜åŒ–** - å‡å°‘ä¸å¿…è¦çš„äº‹ä»¶ç›‘å¬å’Œå¤„ç†

é€šè¿‡è¿™æ¬¡ä¿®å¤ï¼Œæˆ‘ä»¬ä¸ä»…è§£å†³äº†å½“å‰çš„æ‹–æ‹½é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®çš„æ¶æ„åŸºç¡€ã€‚